Sub ExtractMailsFromFolder()
    Dim OutApp As Outlook.Application
    Dim OutNamespace As Outlook.Namespace
    Dim OutFolder As Outlook.MAPIFolder
    Dim OutMail As Outlook.MailItem
    Dim r As Integer
    Dim cutDate As Date
    Dim ws As Worksheet
    
    ' Skapa en instans av Outlook
    On Error Resume Next
    Set OutApp = GetObject(, "Outlook.Application") ' Använd befintlig instans om Outlook redan är igång
    If Err.Number <> 0 Then Set OutApp = New Outlook.Application
    On Error GoTo 0
    
    Set OutNamespace = OutApp.GetNamespace("MAPI")
    Set OutFolder = OutNamespace.GetDefaultFolder(olFolderInbox) ' Starta från inkorgen
    cutDate = DateValue("01/01/2024") ' Filtrera på datum

    ' Sätt arbetsblad och rubriker
    Set ws = ThisWorkbook.Sheets("Sheet1") ' Se till att det finns ett ark med detta namn
    ws.Cells.Clear ' Rensa gammal data
    ws.Range("A1:F1").Value = Array("Mottagningstid", "Avsändarens namn", "Avsändarens e-post", "Mapp", "Ämne", "Meddelande")
    
    r = 1
    Call ProcessFolder(OutFolder, ws, r, cutDate) ' Processa inkorgen och underliggande mappar

    ' Rensa minnet
    Set OutFolder = Nothing
    Set OutNamespace = Nothing
    Set OutApp = Nothing
    
    MsgBox "Export klar! " & r - 1 & " e-postmeddelanden extraherade.", vbInformation
End Sub

' Rekursiv funktion för att gå igenom alla undermappar
Sub ProcessFolder(ByVal Folder As Outlook.MAPIFolder, ByVal ws As Worksheet, ByRef r As Integer, ByVal cutDate As Date)
    Dim OutMail As Object
    Dim SubFolder As Outlook.MAPIFolder
    Dim Items As Outlook.Items
    Dim FilteredItems As Outlook.Items
    Dim i As Integer

    ' Använd Restrict för att effektivt filtrera på ReceivedTime
    Set Items = Folder.Items
    On Error Resume Next
    Set FilteredItems = Items.Restrict("[ReceivedTime] >= '" & Format(cutDate, "MM/DD/YYYY") & "'")
    On Error GoTo 0
    
    ' Loopa igenom filtrerade e-postmeddelanden
    For i = 1 To FilteredItems.Count
        On Error Resume Next
        Set OutMail = FilteredItems.Item(i)
        If Not OutMail Is Nothing Then
            If OutMail.Class = olMail Then ' Säkerställ att objektet är ett e-postmeddelande
                r = r + 1
                ws.Cells(r, 1).Value = OutMail.ReceivedTime
                ws.Cells(r, 2).Value = OutMail.SenderName
                ws.Cells(r, 3).Value = GetSenderEmail(OutMail) ' Hämta avsändarens e-postadress
                ws.Cells(r, 4).Value = Folder.Name ' Lägg till mappens namn
                ws.Cells(r, 5).Value = OutMail.Subject
                ws.Cells(r, 6).Value = OutMail.Body
            End If
        End If
    Next i

    ' Loopa igenom alla undermappar och anropa funktionen rekursivt
    For Each SubFolder In Folder.Folders
        Call ProcessFolder(SubFolder, ws, r, cutDate)
    Next SubFolder
End Sub

' Funktion för att hämta avsändarens e-postadress
Function GetSenderEmail(OutMail As Outlook.MailItem) As String
    Dim AddressEntry As Outlook.AddressEntry
    Dim ExchangeUser As Outlook.ExchangeUser
    
    On Error Resume Next
    Set AddressEntry = OutMail.Sender
    If Not AddressEntry Is Nothing Then
        Select Case AddressEntry.AddressEntryUserType
            Case olExchangeUserAddressEntry, olExchangeRemoteUserAddressEntry
                Set ExchangeUser = AddressEntry.GetExchangeUser
                If Not ExchangeUser Is Nothing Then
                    GetSenderEmail = ExchangeUser.PrimarySmtpAddress
                Else
                    GetSenderEmail = "Okänd"
                End If
            Case Else
                GetSenderEmail = AddressEntry.Address
        End Select
    Else
        GetSenderEmail = "Okänd"
    End If
    On Error GoTo 0
End Function
