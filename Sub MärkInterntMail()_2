Sub M√§rkInterntMail()
    Dim olMail As Outlook.MailItem
    Dim olFolder As Outlook.Folder
    Dim olItem As Object
    Dim itemList As Collection
    Dim myAddress As String
    Dim myDomain As String
    Dim senderAddress As String
    Dim senderDomain As String

    ' ‚úÖ Ange din e-postadress h√§r (h√•rdkodat)
    myAddress = "din.epost@dindom√§n.se"  ' <-- √Ñndra detta!
    myDomain = LCase(Mid(myAddress, InStr(1, myAddress, "@") + 1))

    ' üìÅ V√§lj mapp manuellt
    Set olFolder = Application.Session.PickFolder
    If olFolder Is Nothing Then
        MsgBox "Ingen mapp vald.", vbExclamation
        Exit Sub
    End If

    ' üìã Samla alla mejl i mappen f√∂rst, f√∂r stabil loop
    Set itemList = New Collection
    For Each olItem In olFolder.Items
        If TypeOf olItem Is Outlook.MailItem Then
            itemList.Add olItem
        End If
    Next

    ' üîÅ G√• igenom och m√§rka alla som matchar dom√§n
    For Each olMail In itemList
        senderAddress = GetSenderSMTP(olMail)
        If senderAddress <> "" Then
            senderDomain = LCase(Mid(senderAddress, InStr(1, senderAddress, "@") + 1))

            If senderDomain = myDomain Then
                olMail.Categories = "Internt" ' üé® Se till att denna kategori finns (gul f√§rg)
                olMail.Save
            End If
        End If
    Next

    MsgBox "F√§rdig! Alla mejl fr√•n samma dom√§n √§r markerade med 'Internt'.", vbInformation
End Sub


Function GetSenderSMTP(mail As Outlook.MailItem) As String
    On Error Resume Next

    Dim sender As Outlook.AddressEntry
    Dim exchUser As Outlook.ExchangeUser
    Dim smtpAddress As String

    Set sender = mail.Sender

    If Not sender Is Nothing Then
        ' Hantera interna adresser
        If sender.AddressEntryUserType = olExchangeUserAddressEntry Or _
           sender.AddressEntryUserType = olExchangeRemoteUserAddressEntry Then

            Set exchUser = sender.GetExchangeUser
            If Not exchUser Is Nothing Then
                smtpAddress = exchUser.PrimarySmtpAddress
            End If
        Else
            ' Hantera externa (SMTP) adresser
            smtpAddress = sender.Address
        End If
    End If

    GetSenderSMTP = smtpAddress
End Function
